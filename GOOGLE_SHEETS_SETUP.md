# Googleスプレッドシート連携設定ガイド

AIサルバさんの会話履歴をスプレッドシートに記録するための設定手順です。
少し手順が多いですが、一つずつ進めれば大丈夫です！

## 手順1: Google Cloudプロジェクトを作る

1.  [Google Cloud Console](https://console.cloud.google.com/) にアクセスします（Googleアカウントでログインしてください）。
2.  画面左上のロゴの横にある「プロジェクトの選択」（または現在のプロジェクト名）をクリックします。
3.  右上の **「新しいプロジェクト」** をクリックします。
4.  **プロジェクト名**: `ai-salva-chat` （なんでもOKです）と入力し、**「作成」** をクリックします。
5.  作成完了の通知が出たら、**「プロジェクトを選択」** をクリックして、そのプロジェクトの画面に移動します。

## 手順2: Google Sheets APIを有効にする

1.  画面左上のメニュー（三本線）をクリックし、**「APIとサービス」** > **「ライブラリ」** を選択します。
2.  検索バーに `Google Sheets API` と入力して検索します。
3.  検索結果の **「Google Sheets API」** をクリックします。
4.  **「有効にする」** ボタンをクリックします。

## 手順3: サービスアカウントを作る

これがいわゆる「ロボット用のアカウント」です。

1.  APIを有効にすると、概要画面に移動します。右上の **「認証情報を作成」** をクリックします。
2.  **「認証情報の種類」** で以下を選択します：
    -   使用するAPI: **Google Sheets API**
    -   アクセスするデータの種類: **アプリケーションデータ**
    -   Compute Engine...: **いいえ、使用していません**
3.  **「次へ」** をクリックします。
4.  **「サービスアカウントの詳細」**:
    -   サービスアカウント名: `salva-recorder` （なんでもOK）
    -   **「作成して続行」** をクリックします。
5.  **「ロール」**（権限）の設定:
    -   「ロールを選択」をクリックし、**「基本」** > **「編集者」** を選びます。
    -   **「続行」** をクリックし、最後に **「完了」** をクリックします。

## 手順4: JSONキー（鍵）を取得する

ここが一番重要です！

1.  画面左側のメニューから **「認証情報」** をクリックします。
2.  「サービスアカウント」という欄に、先ほど作ったアカウント（例: `salva-recorder@...`）があるはずです。その **メールアドレスをクリック** します。
3.  上の方にある **「キー」** タブをクリックします。
4.  **「鍵を追加」** > **「新しい鍵を作成」** をクリックします。
5.  キーのタイプで **「JSON」** が選ばれていることを確認し、**「作成」** をクリックします。
6.  **自動的にファイルがダウンロードされます。** これが「JSONキー」です！
    -   ファイル名は `ai-salva-chat-xxxx.json` のようになっています。
    -   **注意**: このファイルはパスワードと同じくらい重要です。他人に見せないでください。

## 手順5: スプレッドシートを共有する

ロボット（サービスアカウント）が書き込めるように、スプレッドシートを共有します。

1.  Googleスプレッドシートで、記録用の新しいシートを作ります。
2.  右上の **「共有」** ボタンをクリックします。
3.  **「ユーザーやグループを追加」** の欄に、**手順4-2で確認したサービスアカウントのメールアドレス**（`xxx@xxx.iam.gserviceaccount.com`）を入力します。
    -   ※ダウンロードしたJSONファイルの中にも `client_email` として書かれています。
4.  権限が **「編集者」** になっていることを確認し、**「送信」** をクリックします。

## 手順6: アプリに設定する

最後に、アプリに鍵情報を登録します。

1.  VS Codeで `.env.local` ファイルを開きます。
2.  以下の3つの項目を追加（または修正）します。

```text
GOOGLE_SHEETS_ID=ここにスプレッドシートIDを入れる
GOOGLE_SERVICE_ACCOUNT_EMAIL=ここにサービスアカウントのメールアドレスを入れる
GOOGLE_PRIVATE_KEY="ここに秘密鍵を入れる"
```

### 各項目の見つけ方

-   **GOOGLE_SHEETS_ID**:
    -   スプレッドシートを開いているときのURLを見てください。
    -   `https://docs.google.com/spreadsheets/d/` **ここがIDです** `/edit...`
    -   長い英数字の羅列部分だけをコピーします。

-   **GOOGLE_SERVICE_ACCOUNT_EMAIL**:
    -   ダウンロードしたJSONファイルを開き、`"client_email"` の右側のメールアドレスをコピーします。

-   **GOOGLE_PRIVATE_KEY**:
    -   ダウンロードしたJSONファイルを開き、`"private_key"` の右側の文字列をコピーします。
    -   `-----BEGIN PRIVATE KEY-----\n...` から始まり `\n-----END PRIVATE KEY-----\n` で終わる、とても長い文字列です。
    -   **重要**: `.env.local` に貼り付けるときは、全体をダブルクォーテーション `"` で囲んでください。

設定が終わったら、ファイルを保存し、ターミナルで `Ctrl+C` を押してサーバーを停止し、`npm run dev` で再起動してください。
これで完了です！
