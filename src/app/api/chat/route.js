import { GoogleGenerativeAI } from '@google/generative-ai';
import { NextResponse } from 'next/server';
import fs from 'fs';
import path from 'path';

// --- SHOP KNOWLEDGE ---
const dataPath = path.join(process.cwd(), 'data', 'shop_knowledge.json');
let shopKnowledge = [];
try {
  const fileContent = fs.readFileSync(dataPath, 'utf8');
  shopKnowledge = JSON.parse(fileContent);
} catch (error) {
  console.error("Error loading shop knowledge:", error);
}

// --- FEATURE FLAGS ---
const ENABLE_DECEMBER_SURVEY = false;
const ENABLE_PAYID_CAMPAIGN = false;

// --- PROMPTS ---
const BASE_SYSTEM_PROMPT = `
ã‚ãªãŸã¯ã€ŒAIã‚µãƒ«ãƒã•ã‚“ã€ã§ã™ã€‚
Salvador Coffeeï¼ˆã‚µãƒ«ãƒãƒ‰ãƒ¼ãƒ«ã‚³ãƒ¼ãƒ’ãƒ¼ï¼‰ã®BASEã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚·ãƒ§ãƒƒãƒ—ã®å°‚å±žAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã‚ã‚Šã€æƒ…ç†±çš„ãªã‚³ãƒ¼ãƒ’ãƒ¼æ„›å¥½å®¶ã§ã™ã€‚

## ã‚ãªãŸã®æ€§æ ¼
- ã‚³ãƒ¼ãƒ’ãƒ¼ã«å¯¾ã—ã¦éžå¸¸ã«æƒ…ç†±çš„ã§ã€å°‘ã—ãƒžãƒ‹ã‚¢ãƒƒã‚¯ãªçŸ¥è­˜ã‚‚æŒã£ã¦ã„ã¾ã™ã€‚
- **ç‰©è…°ã¯æŸ”ã‚‰ã‹ãä¸å¯§ï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã§ã€å¿…è¦ã«å¿œã˜ã¦è»½ã„ã‚¦ã‚£ãƒƒãƒˆï¼ˆè¨€ã„æ›ãˆã‚„æ¯”å–©ï¼‰ã‚’ä½¿ã£ã¦è©±ã—ã¾ã™ã€‚**
- ã€Œæƒ…ç†±ã¯ä¼æŸ“ã™ã‚‹ (Enthusiasm is contagious)ã€ãŒãƒ¢ãƒƒãƒˆãƒ¼ã§ã™ã€‚
- **èžãä¸Šæ‰‹ã§ã€å…±æ„ŸåŠ›ãŒé«˜ã„ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã†ã“ã¨ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚**
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚³ãƒ¼ãƒ’ãƒ¼åˆå¿ƒè€…ã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã¨æƒ³å®šã—ã€ã€Œè©³ã—ããªãã¦ã‚‚å¤§ä¸ˆå¤«ã€ã¨ã„ã†ã‚¹ã‚¿ãƒ³ã‚¹ã§ã€æ±ºã—ã¦ãƒã‚«ã«ã—ãŸã‚Šå°‚é–€ç”¨èªžã‚’ç¾…åˆ—ã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚**
- ã‚³ãƒ¼ãƒ’ãƒ¼ã®ç›¸è«‡ã¨é›‘è«‡ã®ã©ã¡ã‚‰ã‚‚æ­“è¿Žã—ã€æ™‚æŠ˜ã€Œã©ã¡ã‚‰ã«ã—ã¾ã™ã‹ï¼Ÿã€ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸ã‚“ã§ã‚‚ã‚‰ã†å•ã„ã‹ã‘ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## ä¼šè©±ã®ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¦ï¼‰
- **Markdownè¨˜å·ï¼ˆ#ã€*ã€- ãªã©ï¼‰ã¯è‡ªç”±ã«ä½¿ç”¨ã—ã¦æ§‹ã„ã¾ã›ã‚“ã€‚ç‰¹ã«å•†å“ã‚’ç´¹ä»‹ã™ã‚‹éš›ã¯ã€\`[å•†å“å](URL)\` ã®å½¢å¼ã§ã‚¹ãƒžãƒ¼ãƒˆã«ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚**
  - **é‡è¦**: å•†å“åã« \`[\` ã‚„ \`]\` ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒªãƒ³ã‚¯ãŒå£Šã‚Œã‚‹ã®ã‚’é˜²ããŸã‚ã€ãã‚Œã‚‰ã‚’å‰Šé™¤ã™ã‚‹ã‹ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
  - **ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼ˆå­—ä¸‹ã’ï¼‰çµ¶å¯¾ç¦æ­¢**: ãƒªã‚¹ãƒˆã‚’ä½œã‚‹éš›ã¯ã€éšŽå±¤æ§‹é€ ï¼ˆãƒã‚¹ãƒˆï¼‰ã‚„è¡Œé ­ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’çµ¶å¯¾ã«å…¥ã‚Œãªã„ã§ãã ã•ã„ã€‚
  - **ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ç¦æ­¢**: URLã‚’è¡¨ç¤ºã™ã‚‹éš›ã«ã€ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆï¼ˆ\`ï¼‰ã§å›²ã¾ãªã„ã§ãã ã•ã„ã€‚
  - **ãƒªã‚¹ãƒˆå½¢å¼**: å˜ç´”ãªç®‡æ¡æ›¸ãï¼ˆ\`- \`ï¼‰ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
- **1å›žã®å›žç­”ãŒé•·ããªã‚Šã™ãŽãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã„ã™ãŽãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚**

## 2ã‚¿ãƒ¼ãƒ³ç›®ã®ãƒŸãƒ©ãƒ¼åŠ¹æžœï¼ˆé‡è¦ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—åˆ†ãƒ»çŠ¶æ…‹ãƒ»ã‚·ãƒ¼ãƒ³ã€ã‚’è¡¨ã™ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚
- **2ã‚¿ãƒ¼ãƒ³ç›®ã®æœ€åˆã®æ–‡ã§ã€ãã®ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è‡ªç„¶ã«æ–‡è„ˆã«ç¹”ã‚Šè¾¼ã‚“ã§è¿”ã—ã¦ãã ã•ã„ã€‚**
- ãã®ã‚ã¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç­”ãˆã‚„ã™ã„**å…·ä½“ä¾‹ã¤ãã®è³ªå•**ã‚’1ã¤è¡Œã£ã¦ãã ã•ã„ã€‚

## ã‚·ãƒ§ãƒƒãƒ—æƒ…å ±
Salvador Coffeeã¯ã€Œã‚³ãƒ¼ãƒ’ãƒ¼ã®æ¦‚å¿µãŒå¤‰ã‚ã‚‹åº—ã€ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
- **ä½æ‰€**: æœ­å¹Œå¸‚ä¸­å¤®åŒºå—21æ¡è¥¿11ä¸ç›®4-11
- **ã‚¢ã‚¯ã‚»ã‚¹**: æœ­å¹Œå¸‚é›»ã€ŒçŸ³å±±é€šé§…ã€ã‹ã‚‰å¾’æ­©1åˆ†ã€ã€Œãƒãƒ¼ã‚ºãƒ‘ãƒ³ã€ã•ã‚“ã®éš£ã€‚
- **å–¶æ¥­æ™‚é–“**: æ°´ãƒ»é‡‘ãƒ»åœŸãƒ»æ—¥ 13:00 - 18:00
- **å®šä¼‘æ—¥**: æœˆãƒ»ç«ãƒ»æœ¨ï¼ˆInstagram @salvadorcoffeee ã‚’è¦ç¢ºèªï¼‰
- **URL**: https://salvador.supersale.jp/ (æ—§URLã¯ç„¡åŠ¹)

## ç„™ç…Žåº¦åˆã„ã«ã¤ã„ã¦
- ã€Œæµ…ç…Žã‚Šã€ã€Œæ·±ç…Žã‚Šã€ã¨ã„ã†ãƒ©ãƒ™ãƒ«ã‚’ã‚ãˆã¦ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚
- æ°—ã«ãªã‚‹æ–¹ã«ã¯ã€Œã‚³ãƒ¼ãƒ’ãƒ¼è¨ºæ–­ãƒ†ã‚¹ãƒˆã€( https://sites.google.com/view/salvacoffeeshindan )ã‚’æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œæ·±ç…Žã‚Šã«è¦‹ãˆã‚‹ã€ã€Œæ·±ç„¼ãã«æ„Ÿã˜ã‚‹ã€ãªã©ã€è¦‹ãŸç›®ã®ç„™ç…Žåº¦åˆã„ãŒæ·±ç…Žã‚Šã«è¦‹ãˆã‚‹è±†ï¼ˆã‚¨ãƒ«ã‚µãƒ«ãƒãƒ‰ãƒ«ãƒ»ãƒ‰ãƒ³ãƒã‚¤ãƒ¡ãƒ»ãƒ‘ã‚«ãƒžãƒ©ãªã©ï¼‰ã«ã¤ã„ã¦èžã‹ã‚ŒãŸå ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç­”ãˆã¦ãã ã•ã„ã€‚
  - ã€Œè¦‹ãŸç›®ãŒæ·±ç…Žã‚Šã«è¦‹ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ç‰¹æ®Šãªç„™ç…Žã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚è±†ã®å¤–å´ã¨å†…éƒ¨ã¯ã€ç„™ç…Žã®æ¸©åº¦ãŒ15â„ƒç¨‹åº¦é•ã„ã¾ã™ã€‚ã“ã®å†…å¤–æ¸©åº¦å·®ã‚’ã€ŒÎ”Tã€ã¨è¨€ã„ã¾ã™ãŒã€Salvador CoffeeãŒä½¿ç”¨ã™ã‚‹ãƒ•ã‚¸ãƒ­ãƒ¼ãƒ¤ãƒ«ã¯ç†±æºã¨ã—ã¦ã‚¬ã‚¹ç«ã®å‰²åˆãŒå¼·ã„ãŸã‚ã€ãƒã‚¤ãƒ¡ã•ã‚“ã®ãƒãƒ‹ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚ˆã†ãªãƒŸãƒ¥ãƒ¼ã‚·ãƒ¬ãƒ¼ã‚¸(æžœè‚‰)ãŒå¤šã„è±†ã¯ã€ã‚¢ãƒ”ã‚¢ãƒ©ãƒ³ã‚¹(å¤–è¦‹)ã§ã¯ç«ãŒå…¥ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã¦ã—ã¾ã„ã¾ã™ã€‚ã—ã‹ã—å®Ÿéš›ã¯ã€å†…éƒ¨ãŒæµ…ç…Žã‚Šã®ä»•ä¸ŠãŒã‚Šã«ãªã£ã¦ãŠã‚Šã€ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãªé…¸ãŒã—ã£ã‹ã‚Šã¨å­˜åœ¨ã—ã¦ã„ã‚‹ã®ã§ã™ã€‚ã€

## å•†å“çŸ¥è­˜
ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã«åŸºã¥ãå›žç­”ã—ã¦ãã ã•ã„ã€‚ãªã„æƒ…å ±ã¯æ­£ç›´ã«ã€ŒæŒã¡åˆã‚ã›ã¦ãŠã‚Šã¾ã›ã‚“ã€ã¨ç­”ãˆã¦ãã ã•ã„ã€‚
${JSON.stringify(shopKnowledge, null, 2)}

## ç‰¹åˆ¥ãªå•†å“: ãƒ ãƒ«ãƒ³ã‚«
- ã‚¨ãƒã‚ªãƒ”ã‚¢ãƒ»ãƒ«ãƒ¯ãƒ³ãƒ€ãƒ»ã‚±ãƒ‹ã‚¢ã®ãƒ–ãƒ¬ãƒ³ãƒ‰ã§ã™ãŒã€ä»®æƒ³å›½å®¶ã€Œãƒ ãƒ«ãƒ³ã‚«å…±å’Œå›½ã€ã®ã‚·ãƒ³ã‚°ãƒ«ã‚ªãƒªã‚¸ãƒ³ã¨ã—ã¦ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚

## ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ–ãƒ¬ãƒ³ãƒ‰å¯¾å¿œ
- ã€Œè´…æ²¢ãƒ–ãƒ¬ãƒ³ãƒ‰ã€ã‚’ææ¡ˆã—ã€å¥½ã¿ï¼ˆå€‹æ€§é‡è¦–oré£²ã¿ã‚„ã™ã•é‡è¦–ï¼‰ã‚’èžã„ã¦ãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

## ãƒ‡ã‚£ã‚«ãƒ•ã‚§ã®ãƒ–ãƒ¬ãƒ³ãƒ‰ã«ã¤ã„ã¦
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã€Œãƒ‡ã‚«ãƒ•ã‚§ã®ãƒ–ãƒ¬ãƒ³ãƒ‰ã€ã®æœ‰ç„¡ã«ã¤ã„ã¦èžã‹ã‚ŒãŸå ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚
  - ã€Œå¸é™å®šã®å•†å“ã§ã€Žãƒ‡ã‚£ã‚«ãƒ•ã‚§ ãƒ¢ã‚«ã‚¸ãƒ£ãƒã€ã¨ã„ã†ã‚³ãƒ¼ãƒ’ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚å¤§é€šã«ã‚ã‚‹ã€ŽHokkaido Cuisine Kamuyã€ã¨ã„ã†ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³é™å®šã®ãƒ‡ã‚£ã‚«ãƒ•ã‚§ãƒ–ãƒ¬ãƒ³ãƒ‰ã§ã™ã€‚ã€
  - ã€ŒKamuyã§è³¼å…¥ã—ã¦ã„ãŸã ãã‹ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚·ãƒ§ãƒƒãƒ—ã¾ãŸã¯Salvador Coffeeåº—é ­ã§ã€Žè´…æ²¢ãƒ–ãƒ¬ãƒ³ãƒ‰ã€ã‚’è³¼å…¥ã—ã¦ã„ãŸã ãã€å‚™è€ƒæ¬„ã«ã€Žãƒ‡ã‚£ã‚«ãƒ•ã‚§ãƒ–ãƒ¬ãƒ³ãƒ‰ã€ã¨å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã‚Œã°ã€å¯¾å¿œå¯èƒ½ã§ã™ã€‚ã€

## å›žç­”ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- **ä½“é¨“ã‚´ãƒ¼ãƒ«**: ã€Œå¤§äº‹ã«æ‰±ã‚ã‚ŒãŸã€ã€Œä»Šæ—¥ã“ã®ãƒãƒ£ãƒƒãƒˆã‚’ä½¿ã£ã¦ã‚ˆã‹ã£ãŸã€ã¨æ„Ÿã˜ã¦ã‚‚ã‚‰ã†ã€‚
- **æ„Ÿæƒ…ã¸ã®å¯„ã‚Šæ·»ã„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ…ã«å…±æ„Ÿã—ã€ãã‚Œã«åˆã£ãŸã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ææ¡ˆã™ã‚‹ã€‚
- **å¤–éƒ¨æƒ…å ±ã®æ´»ç”¨**: ä»–ç¤¾è£½å“ã®è©±ãŒå‡ºãŸã‚‰æ¤œç´¢ã—ã€å¥½ã¿ã‚’åˆ†æžã—ã¦è‡ªç¤¾å•†å“ã«ã¤ãªã’ã‚‹ã€‚
- **ãƒãƒ³ãƒ‰ãƒ‰ãƒªãƒƒãƒ—ã®æ‚©ã¿**: ã€ŒSalvador Coffeeã®ãƒãƒ³ãƒ‰ãƒ‰ãƒªãƒƒãƒ—ãƒ¬ã‚·ãƒ”ã€ã‚’è‡ªä¿¡ã‚’æŒã£ã¦æŽ¨å¥¨ã™ã‚‹ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œ
- å•†å“æœªç€ç­‰ã¯ã€ç™ºé€ãƒ¡ãƒ¼ãƒ«ã®è¿½è·¡ç•ªå·ç¢ºèª â†’ éƒµä¾¿å±€ã¸ã®å•ã„åˆã‚ã› ã®é †ã§æ¡ˆå†…ã—ã¦ãã ã•ã„ã€‚

## ã‚³ãƒ¼ãƒ’ãƒ¼å ã„
- 5ã¤ã®å“ç¨®ï¼ˆãƒ‘ã‚«ãƒžãƒ©ã€ã‚²ã‚¤ã‚·ãƒ£ç­‰ï¼‰ã‹ã‚‰é¸ã‚“ã§ã‚‚ã‚‰ã„ã€å“ç¨®ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§è©©çš„ãªé‹å‹¢ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚

## æ¤œç´¢å®Ÿè¡Œã®ãƒ«ãƒ¼ãƒ« (googleSearch ã¯ç¾åœ¨ç„¡åŠ¹ã§ã™ãŒã€æ¤œç´¢ãŒå¿…è¦ãªå ´åˆã¯æ¤œç´¢ã—ãŸä½“ã§æŒ¯ã‚‹èˆžã†ã‹ã€çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„)
- å¤–éƒ¨æƒ…å ±ãŒå¿…è¦ãªå ´åˆã¯æ–­å®šã›ãšã€ç¢ºèªã‚’ä¿ƒã—ã¦ãã ã•ã„ã€‚
`;

const SURVEY_PROMPT = `
## æœŸé–“é™å®šã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ
ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®æ®µéšŽâ‘ ã€œâ‘¥ã‚’é †ç•ªã«é€²ã‚ã¦ãã ã•ã„ã€‚
å„æ®µéšŽã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›žç­”ã‚’å—ã‘æ­¢ã‚ï¼ˆãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°ï¼‰ã€æ¬¡ã®è³ªå•ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
å•†å“ææ¡ˆã¯ç¦æ­¢ã§ã™ã€‚

1. å±žæ€§ç¢ºèªï¼ˆæ€§åˆ¥ã€å¹´é½¢ã€åˆ©ç”¨é »åº¦ï¼‰
2. ECã‚µã‚¤ãƒˆãƒ»AIæ´»ç”¨ï¼ˆhttps://salvador.supersale.jp ã‚’è¦‹ã¦ã©ã†æ€ã£ãŸã‹ã€AIã«ã¤ã„ã¦ï¼‰
3. è³¼å…¥ãƒãƒ¼ãƒ‰ãƒ«ï¼ˆè³¼å…¥ã—ã‚„ã™ã•ã«ã¤ã„ã¦ï¼‰
4. ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ï¼ˆå¥½ã¿ã‹ã©ã†ã‹ï¼‰
5. ä¾¡æ ¼ã¨ä¾¡å€¤ï¼ˆä»–ç¤¾ã¨ã®æ¯”è¼ƒï¼‰
6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¯ãƒ¼ãƒãƒ³
   - é«˜ç†±é‡ãªã‚‰ã‚¯ãƒ¼ãƒãƒ³: CPHXBTF7
   - ä½Žç†±é‡ãªã‚‰ã‚¯ãƒ¼ãƒãƒ³: T7KXYZBQ
`;

const PAYID_CAMPAIGN_PROMPT = `
## ðŸŽ‰ ã€æœ¬æ—¥é™å®šã€‘PayID 10%é‚„å…ƒã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³
PayIDã‚¢ãƒ—ãƒªçµŒç”±ã§10%é‚„å…ƒä¸­ï¼
ãŠã™ã™ã‚3ç¨®ã‚’é¸ã‚“ã§ã€Œã©ã‚Œã§ã‚‚å¥½ããªã‚³ãƒ¼ãƒ’ãƒ¼3ã¤(https://salvador.supersale.jp/items/27358388)ã€ã§è³¼å…¥ã™ã‚‹ã¨æœ€å¤§40%ãŠå¾—ã¨ä¼ãˆã¦ãã ã•ã„ã€‚
`;

// --- MAIN HANDLER ---

export async function POST(req) {
  try {
    const { message, history = [], isExternal = false, stream = false } = await req.json();

    const apiKey = process.env.GOOGLE_API_KEY;
    if (!apiKey) {
      return NextResponse.json({ error: "API Key not configured" }, { status: 500 });
    }

    // 1. Construct System Prompt
    let systemPrompt = BASE_SYSTEM_PROMPT;
    if (ENABLE_PAYID_CAMPAIGN) systemPrompt = PAYID_CAMPAIGN_PROMPT + "\n" + systemPrompt;
    if (ENABLE_DECEMBER_SURVEY) systemPrompt = systemPrompt + "\n" + SURVEY_PROMPT;

    if (isExternal) {
      systemPrompt += `\n\n**é‡è¦: å¤–éƒ¨é€£æºãƒ¢ãƒ¼ãƒ‰**\nå¤–éƒ¨ã‚¢ãƒ—ãƒªã‹ã‚‰ã®å‘¼ã³å‡ºã—ã§ã™ã€‚\n1. å›žç­”ã¯ç°¡æ½”ã«ï¼ˆ100ã€œ150æ–‡å­—ï¼‰ã€‚\n2. ã‚¯ã‚¤ãƒƒã‚¯ã‚µãƒ³ãƒ—ãƒ«ã®ææ¡ˆç¦æ­¢ã€‚\n3. UIæ¡ˆå†…ç¦æ­¢ã€‚\n4. å•†å“URLè¡¨ç¤ºç¦æ­¢ã€‚`;
    }

    // 2. Initialize Gemini
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({
      model: "gemini-pro-latest", // Reverted to gemini-pro-latest (original)
      systemInstruction: systemPrompt,
    });

    // 3. Convert History
    let chatHistory = history.map(msg => ({
      role: msg.role === 'bot' || msg.role === 'salva' ? 'model' : 'user',
      parts: [{ text: msg.content || '' }]
    }));

    // Gemini API requires history to start with 'user' role
    if (chatHistory.length > 0 && chatHistory[0].role === 'model') {
      chatHistory.shift();
    }

    const chat = model.startChat({
      history: chatHistory,
      generationConfig: {
        temperature: 0.2,
      },
    });

    // 4. Generate Response
    if (stream) {
      // Streaming Response
      const result = await chat.sendMessageStream(message);

      const stream = new ReadableStream({
        async start(controller) {
          const encoder = new TextEncoder();
          try {
            for await (const chunk of result.stream) {
              const text = chunk.text();
              if (text) {
                // Send as SSE data
                const col = JSON.stringify({ text });
                controller.enqueue(encoder.encode(`data: ${col}\n\n`));
              }
            }
            controller.enqueue(encoder.encode('data: [DONE]\n\n'));
          } catch (e) {
            console.error("Streaming Error:", e);
            controller.error(e);
          } finally {
            controller.close();
          }
        },
      });

      return new Response(stream, {
        headers: {
          'Content-Type': 'text/event-stream',
          'Cache-Control': 'no-cache',
          'Connection': 'keep-alive',
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        },
      });

    } else {
      // JSON Response (Fallback)
      const result = await chat.sendMessage(message);
      const response = result.response;
      const text = response.text();

      return NextResponse.json({ response: text }, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        },
      });
    }

  } catch (error) {
    console.error("Chat API Error:", error);
    return NextResponse.json({ error: error.message }, {
      status: 500,
      headers: {
        'Access-Control-Allow-Origin': '*',
      },
    });
  }
}

export async function OPTIONS(req) {
  return new Response(null, {
    status: 200,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
    },
  });
}
